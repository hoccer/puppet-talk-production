#!/bin/bash

# check if upstart job was started
/sbin/status filecache | grep running >/dev/null

if [ "$?" -eq "0" ]; then
  curl -k -s -f -m 10 https://<%= @filecache_fqdn %>:<%= @filecache_port %>/status >/dev/null
  ret=$?
  # handle timeout
  if [ "$ret" -eq "28" ]; then
    echo "Filecache service seems to hang. Restarting." | mail -s "Hoccer: Filecache service has been restarted." admins@hoccer.com
    /sbin/restart filecache
  fi
  # handle unknown error
  if [ "$ret" -ne "0" ]; then
    echo "Filecache service has an unknown error. Return value of curl was $ret. See curl manpage." | mail -s "Hoccer: Filecache service has an unknown error." admins@hoccer.com
  fi
fi
